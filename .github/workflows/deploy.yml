name: Deploy to Sever

on:
    push:
        branches: [ "main"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v6
            
          - name: Setup Node.js
            uses: actions/setup-node@v6
            with:
                node-version: '24.12.0'
            
          - name: Build Frontend
            working-directory: ./frontend
            run: |
                npm install
                npm run build
        
          - name: Setup Go
            uses: actions/setup-go@v6
            with:
                go-version: '1.25.4'
        
          - name: BUild Backend
            working-directory: ./backend
            run: |
                go mod tidy
                GOOS=linux GOARCH=amd64 go build -o main .
        
          - name: Deploy to Server
            uses: appleboy/scp-action@master
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.KEY }}
                source: |
                    ./backend/main
                    ./frontend/dist/
                target: "/home/${{ secrets.USERNAME }}/repos/hello/temp"
                strip_components: 1
        
          - name: Execute remote commands
            uses: appleboy/ssh-action@master
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.KEY }}
                script: |
                    pkill hello || true

                    cd -r /home/${{ secrets.USERNAME }}/repos/hello/temp
                    cp -r * /home/${{ secrets.USERNAME }}/repos/hello/
                    chmod +x /home/${{ secrets.USERNAME }}/repos/hello/main

                    nohup /home/${{ secrets.USERNAME }}/repos/hello/main > /home/${{ secrets.USERNAME }}/repos/hello/logs.txt 2>&1 &
                    echo "Deployed successfully"